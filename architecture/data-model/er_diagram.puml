@startuml Shop Management System ER Diagram
!define Table(name) entity name
!define PrimaryKey(key) <u>key</u>
!define ForeignKey(key) key

skinparam entity {
  BackgroundColor LightYellow
  BorderColor DarkGray
  FontSize 12
}

Table(tenants) {
  PrimaryKey(id): UUID
  --
  name: VARCHAR(255) NOT NULL
  slug: VARCHAR(100) UNIQUE NOT NULL
  domain: VARCHAR(255)
  status: tenant_status DEFAULT 'active'
  subscription_plan: VARCHAR(50)
  settings: JSONB
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(users) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  email: VARCHAR(255) UNIQUE NOT NULL
  cognito_sub: VARCHAR(255) UNIQUE
  first_name: VARCHAR(100)
  last_name: VARCHAR(100)
  phone: VARCHAR(20)
  role: user_role DEFAULT 'salesperson'
  status: user_status DEFAULT 'active'
  last_login_at: TIMESTAMP
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(shops) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(owner_id): UUID NOT NULL
  name: VARCHAR(255) NOT NULL
  description: TEXT
  address: TEXT
  city: VARCHAR(100)
  state: VARCHAR(100)
  postal_code: VARCHAR(20)
  country: VARCHAR(2) DEFAULT 'US'
  location: POINT (PostGIS)
  phone: VARCHAR(20)
  email: VARCHAR(255)
  website: VARCHAR(255)
  business_hours: JSONB
  is_active: BOOLEAN DEFAULT true
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(categories) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(parent_id): UUID
  name: VARCHAR(255) NOT NULL
  slug: VARCHAR(255) NOT NULL
  description: TEXT
  image_url: VARCHAR(500)
  is_active: BOOLEAN DEFAULT true
  sort_order: INTEGER DEFAULT 0
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(products) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(category_id): UUID
  ForeignKey(created_by): UUID NOT NULL
  name: VARCHAR(255) NOT NULL
  slug: VARCHAR(255) NOT NULL
  description: TEXT
  short_description: VARCHAR(500)
  sku: VARCHAR(100) UNIQUE NOT NULL
  barcode: VARCHAR(100)
  price: DECIMAL(10,2) NOT NULL
  cost_price: DECIMAL(10,2)
  weight: DECIMAL(8,3)
  dimensions: JSONB
  attributes: JSONB
  tags: TEXT[]
  images: JSONB
  is_active: BOOLEAN DEFAULT true
  is_featured: BOOLEAN DEFAULT false
  in_stock: BOOLEAN DEFAULT true
  stock_quantity: INTEGER DEFAULT 0
  min_stock_level: INTEGER DEFAULT 0
  max_stock_level: INTEGER
  allow_backorder: BOOLEAN DEFAULT false
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(inventory_transactions) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(product_id): UUID NOT NULL
  ForeignKey(user_id): UUID NOT NULL
  ForeignKey(order_id): UUID
  transaction_type: inventory_transaction_type NOT NULL
  quantity: INTEGER NOT NULL
  previous_quantity: INTEGER NOT NULL
  new_quantity: INTEGER NOT NULL
  unit_cost: DECIMAL(10,2)
  total_cost: DECIMAL(10,2)
  notes: TEXT
  reference_number: VARCHAR(100)
  created_at: TIMESTAMP DEFAULT now()
}

Table(orders) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(customer_id): UUID
  ForeignKey(salesperson_id): UUID
  order_number: VARCHAR(50) UNIQUE NOT NULL
  order_type: order_type DEFAULT 'sale'
  status: order_status DEFAULT 'pending'
  payment_status: payment_status DEFAULT 'pending'
  subtotal: DECIMAL(10,2) NOT NULL
  tax_amount: DECIMAL(10,2) DEFAULT 0
  discount_amount: DECIMAL(10,2) DEFAULT 0
  shipping_amount: DECIMAL(10,2) DEFAULT 0
  total_amount: DECIMAL(10,2) NOT NULL
  currency: VARCHAR(3) DEFAULT 'USD'
  customer_email: VARCHAR(255)
  customer_phone: VARCHAR(20)
  customer_name: VARCHAR(255)
  delivery_address: JSONB
  delivery_method: delivery_method
  delivery_date: TIMESTAMP
  notes: TEXT
  metadata: JSONB
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(order_items) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(order_id): UUID NOT NULL
  ForeignKey(product_id): UUID NOT NULL
  product_name: VARCHAR(255) NOT NULL
  product_sku: VARCHAR(100) NOT NULL
  quantity: INTEGER NOT NULL
  unit_price: DECIMAL(10,2) NOT NULL
  total_price: DECIMAL(10,2) NOT NULL
  created_at: TIMESTAMP DEFAULT now()
}

Table(payments) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(order_id): UUID NOT NULL
  payment_method: payment_method NOT NULL
  amount: DECIMAL(10,2) NOT NULL
  currency: VARCHAR(3) DEFAULT 'USD'
  status: payment_status DEFAULT 'pending'
  gateway_transaction_id: VARCHAR(255)
  gateway_response: JSONB
  processed_at: TIMESTAMP
  created_at: TIMESTAMP DEFAULT now()
}

Table(invoices) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(order_id): UUID NOT NULL
  invoice_number: VARCHAR(50) UNIQUE NOT NULL
  issue_date: TIMESTAMP DEFAULT now()
  due_date: TIMESTAMP
  status: invoice_status DEFAULT 'draft'
  subtotal: DECIMAL(10,2) NOT NULL
  tax_amount: DECIMAL(10,2) DEFAULT 0
  total_amount: DECIMAL(10,2) NOT NULL
  pdf_url: VARCHAR(500)
  sent_at: TIMESTAMP
  created_at: TIMESTAMP DEFAULT now()
  updated_at: TIMESTAMP DEFAULT now()
}

Table(notifications) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(user_id): UUID NOT NULL
  type: notification_type NOT NULL
  title: VARCHAR(255) NOT NULL
  message: TEXT NOT NULL
  data: JSONB
  read_at: TIMESTAMP
  created_at: TIMESTAMP DEFAULT now()
}

Table(audit_logs) {
  PrimaryKey(id): UUID
  --
  ForeignKey(tenant_id): UUID NOT NULL
  ForeignKey(user_id): UUID
  action: VARCHAR(100) NOT NULL
  resource_type: VARCHAR(100) NOT NULL
  resource_id: UUID
  changes: JSONB
  ip_address: INET
  user_agent: TEXT
  created_at: TIMESTAMP DEFAULT now()
}

' Materialized Views for Performance
Table(daily_sales_summary) {
  PrimaryKey(tenant_id, date)
  --
  tenant_id: UUID NOT NULL
  date: DATE NOT NULL
  total_orders: INTEGER DEFAULT 0
  total_revenue: DECIMAL(12,2) DEFAULT 0
  total_items_sold: INTEGER DEFAULT 0
  avg_order_value: DECIMAL(10,2) DEFAULT 0
  top_selling_product_id: UUID
  updated_at: TIMESTAMP DEFAULT now()
}

Table(salesperson_performance) {
  PrimaryKey(tenant_id, salesperson_id, month)
  --
  tenant_id: UUID NOT NULL
  salesperson_id: UUID NOT NULL
  month: DATE NOT NULL
  orders_count: INTEGER DEFAULT 0
  total_sales: DECIMAL(12,2) DEFAULT 0
  commission_earned: DECIMAL(10,2) DEFAULT 0
  updated_at: TIMESTAMP DEFAULT now()
}

Table(product_popularity) {
  PrimaryKey(tenant_id, product_id, month)
  --
  tenant_id: UUID NOT NULL
  product_id: UUID NOT NULL
  month: DATE NOT NULL
  times_ordered: INTEGER DEFAULT 0
  quantity_sold: INTEGER DEFAULT 0
  revenue_generated: DECIMAL(12,2) DEFAULT 0
  updated_at: TIMESTAMP DEFAULT now()
}

' Relationships
tenants ||--o{ users : "has"
tenants ||--o{ shops : "owns"
tenants ||--o{ categories : "has"
tenants ||--o{ products : "has"
tenants ||--o{ orders : "processes"

users ||--o{ shops : "owns"
users ||--o{ products : "created"
users ||--o{ orders : "serves"
users ||--o{ inventory_transactions : "performs"

categories ||--o{ products : "contains"
categories ||--o{ categories : "parent_of"

products ||--o{ order_items : "sold_in"
products ||--o{ inventory_transactions : "affects"

orders ||--o{ order_items : "contains"
orders ||--o{ payments : "paid_by"
orders ||--o{ invoices : "generates"

shops ||--o{ orders : "fulfills"

@enduml